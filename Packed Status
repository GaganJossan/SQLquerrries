SELECT 
    o.ORDER_DATE_DTTM,
    o.tc_order_id,
    l.tc_lpn_id,
    oi.INVN_TYPE,
    CASE l.lpn_facility_status
        WHEN 10 THEN 'Printed'
        WHEN 12 THEN 'Released'
        WHEN 15 THEN 'In packing'
        WHEN 20 THEN 'Packed'
        WHEN 30 THEN 'Weighed'
        WHEN 40 THEN 'Manifested'
        WHEN 50 THEN 'Loaded on truck'
        WHEN 89 THEN 'Completed VAS'
        WHEN 90 THEN 'Shipped'
        WHEN 99 THEN 'Cancelled'
        ELSE 'Unknown'
    END AS lpn_facility_status_desc,
    oi.ITEM_NAME,
    l.REF_FIELD_3 AS Putwall,
    o.D_COUNTRY_CODE,

    -- FLAG with first ERROR_MESSAGE for INVALID OLPN
    CASE
        -- Case 1: Packed at putwall with valid tracking
        WHEN l.lpn_facility_status = 20
             AND l.REF_FIELD_3 IS NOT NULL
             AND l.tracking_nbr IS NOT NULL
        THEN 'PACK AT PUTWALL ' || l.REF_FIELD_3

        -- Case 2: Packed or weighed at putwall but tracking missing
        WHEN l.lpn_facility_status IN (20, 30)
             AND l.REF_FIELD_3 IS NOT NULL
             AND (l.tracking_nbr IS NULL OR l.tracking_nbr = '')
        THEN COALESCE(
                 (SELECT cet.ERROR_MESSAGE
                  FROM wm.c_enroute_tran cet
                  WHERE cet.TC_LPN_ID = l.tc_lpn_id
                    AND cet.ERROR_MESSAGE IS NOT NULL
                  ORDER BY cet.CREATED_DTTM ASC
                  FETCH FIRST 1 ROW ONLY),
                 'INVALID OLPN'
             )

        -- Case 3: Cancelled and inventory balance check (only allocatable + matching type)
        WHEN l.lpn_facility_status = 99
             AND SUM(
                     CASE 
                         WHEN wmi.ALLOCATABLE = 'Y' 
                              AND oi.INVN_TYPE = wmi.INVENTORY_TYPE
                         THEN wmi.on_hand_qty - wmi.wm_allocated_qty 
                         ELSE 0 
                     END
                 ) > 0
        THEN 'NEED CHASE WAVE'

        WHEN l.lpn_facility_status = 99
             AND SUM(
                     CASE 
                         WHEN wmi.ALLOCATABLE = 'Y' 
                              AND oi.INVN_TYPE = wmi.INVENTORY_TYPE
                         THEN wmi.on_hand_qty - wmi.wm_allocated_qty 
                         ELSE 0 
                     END
                 ) <= 0
        THEN 'NEED CHASE CLEANUP'

        ELSE NULL
    END AS FLAG

FROM wm.orders o
JOIN wm.ORDER_LINE_ITEM oi 
    ON o.ORDER_ID = oi.ORDER_ID
JOIN wm.LPN l 
    ON o.tc_order_id = l.tc_order_id
LEFT JOIN wm.wm_inventory wmi 
    ON oi.item_id = wmi.item_id

WHERE o.DO_STATUS = '150'
  AND o.order_type = 'ECOMM'
  AND l.LPN_FACILITY_STATUS not in  ('30','50')
  AND l.FIRST_ZONE = '95'
 AND l.LAST_ZONE = '95'
 and l.tc_reference_lpn_id is null

GROUP BY 
    o.ORDER_DATE_DTTM,
    o.tc_order_id,
    l.tc_lpn_id,
    l.lpn_facility_status,
    oi.ITEM_NAME,
    oi.INVN_TYPE,
    l.REF_FIELD_3,
    l.tracking_nbr,
    o.D_COUNTRY_CODE,
    o.CREATED_DTTM

ORDER BY
    o.CREATED_DTTM;
